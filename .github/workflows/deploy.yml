name: Deploy Landing Page

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Safe Injection
        env:
          FIREBASE_SECRET: ${{ secrets.FIREBASE_WEB_CONFIG }}
        run: |
          # 1. Pre-Flight Analysis
          if [ -z "$FIREBASE_SECRET" ]; then
            echo "::error::Secret FIREBASE_WEB_CONFIG is empty! Check GitHub Repo Settings."
            exit 1
          else
            echo "✅ Secret detected (Length: ${#FIREBASE_SECRET})"
          fi

          # 2. Encrypt and Inject (Python)
          python3 << 'PYEOF'
          import os
          import base64
          import random
          import string
          
          try:
              secret = os.environ['FIREBASE_SECRET']
              
              # Generate random encryption key
              key = ''.join(random.choices(string.ascii_letters + string.digits, k=16))
              
              # XOR encrypt then base64 encode
              encrypted = ''.join(chr(ord(c) ^ ord(key[i % len(key)])) for i, c in enumerate(secret))
              encoded = base64.b64encode(encrypted.encode('latin-1')).decode('ascii')
              
              with open('index.html', 'r') as f:
                  content = f.read()
              
              # Replace placeholders
              if '__ENCRYPTED_CONFIG__' not in content:
                  print('::warning::Placeholder not found!')
              
              content = content.replace('__ENCRYPTED_CONFIG__', encoded)
              content = content.replace('__ENCRYPTION_KEY__', key)
              
              with open('index.html', 'w') as f:
                  f.write(content)
              
              print(f'✅ Config encrypted (key length: {len(key)}, payload: {len(encoded)} chars)')
          except Exception as e:
              print(f'::error::Python Exception: {e}')
              exit(1)
          PYEOF

          # 3. Post-Flight Verification
          if grep -q "__ENCRYPTED_CONFIG__\|__ENCRYPTION_KEY__\|__FIREBASE_CONFIG_JSON__" index.html; then
            echo "::error::CRITICAL: Placeholder still exists in index.html after injection!"
            exit 1
          else
            echo "✅ Verification Passed: All placeholders replaced."
          fi

      - name: Minify HTML & JS
        run: |
          # Use Python for reliable minification (no npm dependency)
          python3 << 'PYEOF'
          import re

          with open('index.html', 'r') as f:
              content = f.read()

          # Remove HTML comments
          content = re.sub(r'<!--.*?-->', '', content, flags=re.DOTALL)

          # Remove JS single-line comments (but not URLs with //)
          content = re.sub(r'(?<!:)//[^\n]*', '', content)

          # Collapse multiple whitespace/newlines into single space
          content = re.sub(r'\s+', ' ', content)

          # Remove spaces around tags
          content = re.sub(r'>\s+<', '><', content)

          # Trim
          content = content.strip()

          with open('index.html', 'w') as f:
              f.write(content)

          print(f"✅ Minification complete ({len(content)} bytes)")
          PYEOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
