name: Deploy Landing Page

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Safe Injection
        env:
          FIREBASE_SECRET: ${{ secrets.FIREBASE_WEB_CONFIG }}
        run: |
          # 1. Pre-Flight Analysis
          if [ -z "$FIREBASE_SECRET" ]; then
            echo "::error::Secret FIREBASE_WEB_CONFIG is empty! Check GitHub Repo Settings."
            exit 1
          else
            echo "✅ Secret detected (Length: ${#FIREBASE_SECRET})"
          fi

          # 2. Execution (Python)
          python3 -c "
          import os
          try:
              secret = os.environ['FIREBASE_SECRET']
              with open('index.html', 'r') as f: content = f.read()
              
              # Strict Replace
              if '__FIREBASE_CONFIG_JSON__' not in content:
                  print('::warning::Placeholder not found in source file!')
              
              new_content = content.replace('__FIREBASE_CONFIG_JSON__', secret)
              
              with open('index.html', 'w') as f: f.write(new_content)
              print('✅ Injection Script Completed')
          except Exception as e:
              print(f'::error::Python Exception: {e}')
              exit(1)
          "

          # 3. Post-Flight Verification
          if grep -q "__FIREBASE_CONFIG_JSON__" index.html; then
            echo "::error::CRITICAL: Placeholder still exists in index.html after injection!"
            exit 1
          else
            echo "✅ Verification Passed: Placeholder removed."
          fi

      - name: Minify HTML & JS
        run: |
          # Use Python for reliable minification (no npm dependency)
          python3 << 'PYEOF'
          import re
          
          with open('index.html', 'r') as f:
              content = f.read()
          
          # Remove HTML comments
          content = re.sub(r'<!--.*?-->', '', content, flags=re.DOTALL)
          
          # Remove JS single-line comments (but not URLs with //)
          content = re.sub(r'(?<!:)//[^\n]*', '', content)
          
          # Collapse multiple whitespace/newlines into single space
          content = re.sub(r'\s+', ' ', content)
          
          # Remove spaces around tags
          content = re.sub(r'>\s+<', '><', content)
          
          # Trim
          content = content.strip()
          
          with open('index.html', 'w') as f:
              f.write(content)
          
          print(f"✅ Minification complete ({len(content)} bytes)")
          PYEOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
